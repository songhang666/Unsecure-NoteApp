{% extends "base.html" %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="fas fa-{% if note %}edit{% else %}plus{% endif %}"></i> {{ title }}
          </h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-3">
              <label for="id_title" class="form-label">Title</label>
              {{ form.title }}
              {% if form.title.errors %}<div class="text-danger">{{ form.title.errors }}</div>{% endif %}
            </div>
            <div class="mb-3">
              <label for="id_content" class="form-label">Content</label>
              {{ form.content }}
              {% if form.content.errors %}<div class="text-danger">{{ form.content.errors }}</div>{% endif %}
            </div>
            <div class="mb-3">
              <label for="id_image" class="form-label">Image (Optional)</label>
              {{ form.image }}
              {% if form.image.errors %}<div class="text-danger">{{ form.image.errors }}</div>{% endif %}
              {% if note.image %}
                <div class="mt-2">
                  <small class="text-muted">Current image:</small>
                  <br />
                  <img src="{{ note.image.url }}"
                       alt="{{ note.title }}"
                       class="img-thumbnail"
                       style="max-height: 200px" />
                </div>
              {% endif %}
              <div class="mt-2">
                <button type="button" class="btn btn-light" onclick="loadPhoto()">
                  <i class="fas fa-image"></i> Get Random Image
                </button>
                <div class="mt-2" id="random_image" hidden>
                  <small class="text-muted">Random image (save it to upload it)</small>
                  <br />
                  <img id="random_image_file"
                       alt="Unable to load random image"
                       class="img-thumbnail"
                       style="max-height: 200px" />
                </div>
              </div>
              <text class="form-control-plaintext" id="api_url" hidden>
              {% if api_url %}
                {{ api_url }}
              {% else %}
                https://boringapi.com/api/v1/photos/?search={{ note.title_trimmed }}&page=1&limit=10
              {% endif %}
              </text>
            </div>
            <div class="mb-4">
              <div class="form-check">
                {{ form.is_public }}
                <label class="form-check-label" for="id_is_public">
                  <i class="fas fa-globe"></i> Make this note public (can be shared with others)
                </label>
              </div>
              {% if form.is_public.errors %}<div class="text-danger">{{ form.is_public.errors }}</div>{% endif %}
            </div>
            <div class="d-flex justify-content-between">
              <a href="{% if note %}{% url "note_detail" note.pk %}{% else %}{% url "note_list" %}{% endif %}"
                 class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Cancel
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> {{ button_text }}
              </button>
            </div>
          </form>
        </div>
      </div>
      {% if note %}
        <div class="mt-3">
          <a href="{% url "note_delete" note.pk %}" class="btn btn-danger btn-sm">
            <i class="fas fa-trash"></i> Delete Note
          </a>
        </div>
      {% endif %}
    </div>
  </div>
  <script>
      function loadPhoto() {
          const apiUrl = document.getElementById('api_url').textContent.trim();
          fetch(`/get_random_photo?api_url=${encodeURIComponent(apiUrl)}`)
              .then(response => response.json()).then(json => {
                  document.getElementById('random_image_file').src = json.photos[Math.floor(Math.random() * 10) + 1].url;
                  document.getElementById('random_image').hidden = false;
              }).catch(error => {
                  document.getElementById('random_image_file').src = "";
                  document.getElementById('random_image').hidden = false;

              });
      }
  </script>
{% endblock content %}
